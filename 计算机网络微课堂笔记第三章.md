# 计算机网络微课堂笔记第三章 数据链路层

### 3.1 数据链路层概述

**链路（(Link)**就是从一个结点到相邻结点的一段物理线路，而中间没有任何其他的交换结点。

**数据链路(Data Link)**是指把实现通信协议的硬件和软件加到链路上，就构成了数据链路。

数据链路层以**帧**为单位传输和处理数据。

![image-20220614163235162](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614163235162.png)

#### 数据链路层的三个问题

##### 封装成帧

数据链路层给网络层交付的的协议数据单元添加帧头和帧位的操作。

目的是实现数据链路层本身的功能。

![image-20220614163538729](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614163538729.png)

##### 差错检测

通过封装在帧尾的检测码与服务端的检错码来检验传输中的错误。

![image-20220614163705565](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614163705565.png)

##### 可靠传输

尽管误码是不能完全避免的,但若能实现发送方发送什么,接收方就能收到什么,就称为可靠传输。	

*这是对于使用点对点信道的数据链路层来举例子的，对于使用广播信道的数据链路层，还有一些其他的问题*

如编织问题、共享式局域网（无限局域网）通讯冲突问题的等

![image-20220614164014533](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614164014533.png)

### 3.2 详述 封装成帧

封装成帧是指数据链路层给上层交付的协议数据单元添加帧头和帧尾使之成为帧。

#### 作用

##### 帧头和帧尾中包含有重要的控制信息。

![image-20220614164426231](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614164426231.png)

##### 帧头和帧尾可以进行帧定界

但并不是每一种传输方法都有帧定界，如以太网v2用前导码与固定的发送时间来区分每一个帧。 

![image-20220614164639730](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614164639730.png)

#### 透明传输

透明传输是指数据链路层对上层交付的传输数据没有**任何限制**，就好像数据链路层不存在一样。

如按帧标识符定界，当一个帧内有多个帧标识符时，此时会使接受端产生误判，可如下例子中使用的转义字符来解决。

##### 面向字节的物理链路

使用字节填充（或称字符填充)，即转义字符的方法实现透明传输。

![image-20220614165057624](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614165057624.png)

##### 面向比特的物理链路

使用比特填充的方法实现透明传输

如[零比特填充法 引自专栏](https://blog.csdn.net/qq_42179997/article/details/106417822)：

> 零比特填充法又称零比特插入法。在HDLC的帧结构中，若在两个标志字段之间的比特串中，碰巧出现了和标志字段F（01111110）一样的比特组合，那么就会误认为是帧的边界。为了避免出现这种情况，HDLC采用零比特填充法使一帧中两个F字段之间不会出现6个连续1。
>
> 零比特填充法的具体做法是：**在发送端**，当一串比特流尚未加上标志字段时，先用硬件扫描整个帧。**只要发现5个连续1，则立即填入一个0**。因此经过这种零比特填充后的数据，**就可以保证不会出现6个连续1**。**在接收一个帧时**，先找到F字段以确定帧的边界。接着再用硬件对其中的比特流进行扫描。**每当发现5个连续1时，就将这5个连续1后的一个0删除，以还原成原来的比特流**。这样就保证了在所传送的比特流中，不管出现什么样的比特组合，也不至于引起帧边界的判断错误。
>
> 例如：
> 某一非标志字段（**0 1 0 0 1 1 1 1 1 1 0 0 0 1 0 1 0**）中恰好出现“**01111110**”，被误认为是标志字段，则发送端连续发送5 个“1”后，填入1个“0”：**0 1 0 0 1 1 1 1 1 0 1 0 0 0 1 0 1 0**，接收端将5 个连1 之后的“0”删除：**0 1 0 0 1 1 1 1 1 1 0 0 0 1 0 1 0**

![image-20220614165417948](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614165417948.png)

#### 总结

为了提高帧的传输效率，应当使帧的数据部分的长度尽可能大些。
考虑到差错控制等多种因素，每一种数据链路层协议都规定了帧的数据部分的长度上限，即最大传送单元MTU (Maximum Transfer Unit)。![image-20220614165843910](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614165843910.png)



### 3.3 差错检测

实际的通信链路都不是理想的，比特在传输过程中可能会产生差错:1可能会变成0，而0也可能变成1。这称为比特差错。
在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率BER(Bit Error Rate)。

使用差错检测码来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一。

![image-20220614170356775](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614170356775.png)

#### 奇偶校验

在待发送的数据后面添加1位奇偶校验位，使整个数据（包括所添加的校验位在内）中“1”的个数为奇数(奇校验)或偶数(偶校验)。

如果有奇数个位发生误码，则奇偶性发生变化，可以检查出误码
如果有偶数个位发生误码，则奇偶性发生变化，不能检查出误码(漏检）![image-20220614173013452](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614173013452.png)

#### 循环冗余校验CRC

收发双方约定好一个生成多项式G(x);发送方基于待发送的数据和生成多项式计算出差错检测码(冗余码）；将其添加到待传输数据的后面一起传输接收方通过生成多项式来计算收到的数据是否产生了误码。

![image-20220614174341709](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614174341709.png)

![image-20220614174424309](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614174424309.png)

##### 小练习

**发送**![image-20220614174624360](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614174624360.png)

**接收**

![image-20220614174720359](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614174720359.png)

#### 总结

**检错码**只能检测出帧在传输过程中出现了差错，但并不能定位错误，因此**无法纠正错误**。

要想纠正传输中的差错，可以使用冗余信息更多的**纠错码**进行**前向纠错**。但纠错码的开销比较大，在计算机网络中**较少使用**。
循环冗余校验CRC有很好的检错能力（**漏检率非常低**)，虽然计算比较复杂，但非常**易于用硬件实现**，因此**被广泛应用于数据链路层**。
在计算机网络中通常采用我们后续课程中将要讨论的检错重传方式来纠正传输中的差错，或者仅仅是**丢弃检测到差错的帧**，这取决于**数据链路层向其上层提供的是可靠传输服务还是不可靠传输服务**。



### 3.4.1 可靠传输的基本概念

使用**差错检测技术**（例如循环冗余校验CRC)，接收方的数据链路层就可检测出帧在传输过程中是否产生了误码(比特错误)。

![image-20220614184613424](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614184613424.png)

一般情况下，有线链路的误码率比较低，为了减小开销，并不要求数据链路层向上提供可靠传输服务。即使出现了误码，可靠传输的问题由其上层处理。
无线链路易受干扰，误码率比较高，因此要求数据链路层必须向上层提供可靠传输服务。

比特差错只是传输差错中的一种。
从整个计算机网络体系结构来看，传输差错还包括分组丢失、分组失序以及分组重复。

**分组丢失**

![image-20220614185524417](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614185524417.png)

**分组失序**

![image-20220614185612005](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614185612005.png)

分组丢失、分组失序以及分组重复这些传输差错，一般不会出现在数据链路层，而会出现在其上层。
可靠传输服务并不仅局限于数据链路层，其他各层均可选择实现可靠传输。

![image-20220614185839491](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614185839491.png)

可靠传输的实现比较复杂，开销也比较大，是否使用可靠传输取决于应用需求。

#### 小结

![image-20220614185928590](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614185928590.png)

### 3.4.2 可靠传输的实现机制——停止-等待协议SW

#### 确认与否认

首先，每次发送方都只发一个数据分组，接收方对数据分组进行差错检测，检验是否有误码。
如果没有误码，那么给发送方发送ACK确认分组；
如果有误码，则丢弃分组，并给发送方发送NAK否认分组。

![image-20220614190750641](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614190750641.png)

#### 超时重传

接收方收不到数据分组，就不会发送ACK或NAK。如果不采取其他措施，发送方就会一直处于等待接收方ACK或NAK的状态。
为解决该问题，可以在发送方发送完一个数据分组时，启动一个超时计时器。若到了超时计时器所设置的重传时间而发送方仍收不到接收方的任何ACK或NAK，则重传原来的数据分组，这就叫做超时重传。
一般可将重传时间选为略大于“从发送方到接收方的平均往返时间”。

![image-20220614190939173](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614190939173.png)

#### 确认丢失

接收方的ACK在传输过程中丢失的话，就会触发发送方的超时计时器，让发送方重传，如果这样，发送方的数据分组会被重复发送。

为避免分组重复这种传输错误，必须给每个分组带上序号。对于停止-等待协议，由于每发送一个数据分组就停止等待,只要保证每发送一个新的数据分组，其发送序号与上次发送的数据分组的序号不同就可以了，因此用一个比特来编号就够了。

![image-20220614191200349](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614191200349.png)

#### 确认迟到

> 发送方发送的数据分组需要序号，接收方发送的确认分组ACK也需要序号。
> 发送方给接收方发送一个数据分组，接收方可能接收并给发送方发送ACK，此时，如果ACK遇到某些问题，导致该ACK迟到了，那么有可能会触发发送方的超时重发，此时，发送方又发了一个DATA0，接收方误以为是之前的ACK丢包而重发一个ACK，如果没有给ACK编号的话，那么DATA0的两个ACK到达发送方的时候，发送方会误以为DATA1的ACK到了，如此反复，后边是否正确接收数据分组就对不上号了。
> 因此，也必须给ACK多开辟一个比特位进行编号（0或1），让发送方知道这个ACK到底是丢包没传过来，还是迟到没传过来；并对该结果进行抉择（接收还是忽略）。
>
> [引用](https://blog.csdn.net/weixin_44741023/article/details/110038142)

![image-20220614191600111](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614191600111.png)

*对于数据链路层的点对点通信，其往返较为固定，不会出现确认迟到的情况，因此可以不用给确认分组加上标号。*

#### 注意事项

接收端检测到数据分组有误码时，将其丢弃并等待发送方的超时重传。但对于误码率较高的点对点链路，为使发送方**尽早重传**，也可给**发送方发送NAK分组**。

为了让接收方能够判断所收到的数据分组是否是重复的，需要**给数据分组编号**。由于停止-等待协议的停等特性，只需**1个比特编号**就够了，即编号0和1。

为了让发送方能够判断所收到的ACK分组是否是重复的，需要给**ACK分组编号**，所用比特数量**与数据分组编号所用比特数量一样**。数据链路层一般不会出现ACK分组迟到的情况，因此**在数据链路层实现停止-等待协议可以不用给ACK分组编号**。

超时计时器设置的**重传时间**应仔细选择。一般可将重传时间选为略大于“从发送方到接收方的平均往返时间”。在数据链路层点对点的往返时间比较确定，重传时间比较好设定。然而在运输层，由于端到端往返时间非常不确定，设置合适的重传时间有时并不容易。

#### 信道利用率

![image-20220614192309605](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614192309605.png)

TD是发送方发送数据分组耗费的发送时延

RTT是收发双方之间的往返时延

TA是接收方发送确认分组所耗费的发送时延（远小于TD，经常忽略不计）

**当往返时延RTT远大于数据帧发送时延Tp时（例如使用卫星链路)，信道利用率非常低。**

若出现重传，则对于传送有用的数据信息来说，信道利用率还要降低。
为了克服停止-等待协议信道利用率很低的缺点，就产生了另外两种协议，即后退N帧协议GBN和选择重传协议SR。

#### 练习

![image-20220614192652356](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614192652356.png)

![image-20220614192734729](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614192734729.png)

#### 小结

![image-20220614192800320](E:\课件\新建文件夹\计算机网络微课堂\ComputerNetworkNotes\计算机网络微课堂笔记第三章.assets\image-20220614192800320.png)

### 3.4.3

